<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ollama DnD</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    textarea, button { width: 100%; margin-top: 10px; font-size: 16px; }
    #chat { margin-top: 20px; padding: 10px; background: #f0f0f0; white-space: pre-wrap; border: 1px solid #ccc; height: 300px; overflow-y: scroll; }
    .user { color: blue; font-weight: bold; }
    .llm { color: green; font-weight: bold; }
  </style>
</head>
<body>
<h1>Donjons & Dragons - Chat Narratif</h1>
<div id="chat"></div>
<textarea id="prompt" rows="3" placeholder="Ex: Michel entre dans une taverne..."></textarea>
<button onclick="sendPrompt()">Envoyer</button>

<script>
  const chatDiv = document.getElementById('chat');
  const promptInput = document.getElementById('prompt');

  let history = [];

  const basePrompt = `Tu es un ma√Ætre du jeu Chateau & Cr√©atures fantastiques. Tu parles fran√ßais. Tu g√©n√®res des sc√®nes immersives, riches, cr√©dibles et interactives. Ne pose pas de questions ouvertes, continue l‚Äôhistoire de fa√ßon fluide, comme dans une vraie partie.`;

  function updateChat() {
    chatDiv.innerHTML = history.map(item => {
      if (item.role === 'user') return `<div class="user">üë§ ${item.content}</div>`;
      if (item.role === 'assistant') return `<div class="llm">üé≤ ${item.content}</div>`;
    }).join('\n');
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  async function sendPrompt() {
    const userText = promptInput.value.trim();
    if (!userText) return;

    history.push({ role: 'user', content: userText });
    updateChat();
    promptInput.value = "";

    const promptFull = basePrompt + "\n\nHistorique de la partie :\n" +
            history.map(h => (h.role === 'user' ? "Joueur : " : "MJ : ") + h.content).join("\n") +
            "\n\nContinue l‚Äôhistoire :";

    try {
      const res = await fetch('http://localhost:11434/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'llama3',
          prompt: promptFull,
          stream: false
        })
      });

      if (!res.ok) {
        history.push({ role: 'assistant', content: "‚ùå Erreur : " + res.status });
        updateChat();
        return;
      }

      const data = await res.json();
      history.push({ role: 'assistant', content: data.response });
      updateChat();
    } catch (err) {
      history.push({ role: 'assistant', content: "‚ùå Erreur de connexion √† l'API Ollama." });
      updateChat();
      console.error(err);
    }
  }
</script>
</body>
</html>
